<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Phase Transition</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>


<h1>Audio Phase Transitions</h1>
<div id="info"></div>
<h3>Volume</h3> <input type="range" min="0" max="100" value="10"  class="slider" id="volumeRange" onchange="setVolume()">
<h3>Timbre</h3> <input type="range" min="0" max="10" value="1" step="1"  class="slider" id="timbreRange" onchange="setTimbre()">
<button type="button" onclick="togglePlay()" id="playButton">Play</button>
<script>
    const audioCtx = new window.AudioContext();
    const gainNode = audioCtx.createGain();
    gainNode.connect(audioCtx.destination);

    const info  = document.getElementById("info");
    const samples = 120;
    const period = samples/audioCtx.sampleRate;
    const harmonics = [1,2,3,4,5,6,8,10,12,15,20,24];
    const audioBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);

    let weights = harmonics.map(()=>1);

    info.innerHTML=`Sample Rate: ${audioCtx.sampleRate} Period:${(period*1000).toPrecision(2)}ms  Max Freq ${(1/period).toPrecision(4)}`

    function toSeconds(samples) {
        return samples/audioCtx.sampleRate
    }
    function fillAudioBuffer() {
        const timbreExponent = document.getElementById("timbreRange").valueAsNumber;
        for (let i = 0; i < weights.length; i++) {
            weights[i] = 1.0/(Math.pow(harmonics[i], timbreExponent));
        }
        const weightFactor = 1.0/weights.reduce((t,c)=>t+c);
        for (let i = 0; i < weights.length; i++) {
            weights[i] = weights[i]*weightFactor;
        }
        const buffer = audioBuffer.getChannelData(0);

        buffer.fill(0, 0, samples);
        for (let j = 0; j < harmonics.length; j++) {
            const h = harmonics[j];
            const w = weights[j];
            for (let i = 0; i < samples; i++) {
                buffer[i] += Math.sin(2.0*Math.PI*(i*h)/samples)*w
            }
        }

    }
    function setVolume() {
        const volRange = document.getElementById("volumeRange");
        gainNode.gain.setValueAtTime(volRange.valueAsNumber/100, audioCtx.currentTime)
        demo()
    }


    function demo() {
        const source = audioCtx.createBufferSource();
        source.connect(gainNode);
        source.buffer = audioBuffer;
        source.loopEnd=toSeconds(samples)

        // start the source playing
        source.start();
    }
    function setTimbre() {
        fillAudioBuffer()
        const source = audioCtx.createBufferSource();
        source.connect(gainNode);
        source.buffer = audioBuffer;
        source.loopEnd=toSeconds(samples)
        source.loop=true
        source.start(audioCtx.currentTime, 0, toSeconds(samples*200));
    }

    function togglePlay() {
        
    }
    fillAudioBuffer()
    setVolume()

</script>
</body>
</html>